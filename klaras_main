import time
import machine
import random
from pico_i2c_lcd import I2cLcd
from mlx90614 import MLX90614


# --- Hardware Setup ---
# LCD (I2C0)
i2c_lcd = machine.I2C(0, sda=machine.Pin(0), scl=machine.Pin(1), freq=400000)
# Temp Sensor (I2C1)
i2c_sensor = machine.I2C(1, sda=machine.Pin(10), scl=machine.Pin(11), freq=100000)


# Buttons
button1 = machine.Pin(7, machine.Pin.IN, machine.Pin.PULL_UP)
button2 = machine.Pin(8, machine.Pin.IN, machine.Pin.PULL_UP)
button3 = machine.Pin(9, machine.Pin.IN, machine.Pin.PULL_UP)


# Initialize LED pins
# Initialize LED pins and force them OFF immediately
greenLED = machine.Pin(15, machine.Pin.OUT, value=0)  # Starts OFF
redLED = machine.Pin(14, machine.Pin.OUT, value=0)    # Starts OFF
blueLED = machine.Pin(13, machine.Pin.OUT, value=0)   # Starts OFF


# Initialize LCD
lcd_devices = i2c_lcd.scan()
if not lcd_devices:
    print("No LCD found!")
    while True: pass
lcd = I2cLcd(i2c_lcd, lcd_devices[0], 2, 16)


# Initialize Temperature sensor
sensor = MLX90614(i2c_sensor)



# --- Functions ---

def clear_screen():
    lcd.clear()
    lcd.move_to(0, 0)
    time.sleep(0.05)

def wait_for_button():
    while True:
        if not button1.value(): return 1
        if not button2.value(): return 2
        if not button3.value(): return 3
        time.sleep(0.05)




def user_menu():
    while True:  
        blueLED.on()
        redLED.on()
        greenLED.on()
        clear_screen() 
        lcd.putstr("Press button")
        lcd.move_to(1,0) 
        lcd.putstr("to start")
        
        button_push = wait_for_button()
        if button_push:
            blueLED.off()
            redLED.off()
            greenLED.off()

            while True:
                blueLED.on()  
                clear_screen() 
                lcd.putstr("Think of a")
                lcd.move_to(1,0) 
                lcd.putstr("yes/no question")
                clear_screen() 
                lcd.putstr("Press any key")
                lcd.move_to(1,0) 
                lcd.putstr("when ready")
        
                button_push = wait_for_button()
                if button_push:
                    blueLED.off()
                    return None



def get_random_line(filename):
    with open(filename, 'r') as file:
        lines = file.readlines()  # Read all lines into a list
        random_line = random.choice(lines).strip()  # Pick a random line and remove \n
    return random_line





def comment_temp(temp):
    if temp < 25.0:      #luften ger typ temp 24
        clear_screen() 
        lcd.putstr("Cold blooded?")
        time.sleep(2)
        clear_screen()
        lcd.putstr("Now included in")
        lcd.move_to(1,0) 
        lcd.putstr("my calculations")
        time.sleep(2)
        clear_screen()

    elif 25.0 <= temp <= 26.0: 
        clear_screen() 
        lcd.putstr("Middle blooded?")
        time.sleep(2)
        clear_screen()
        lcd.putstr("Now included in")
        lcd.move_to(1,0) 
        lcd.putstr("my calculations")
        time.sleep(2)
        clear_screen()

    else:
        clear_screen() 
        lcd.putstr("Warm blooded?")
        time.sleep(2)
        clear_screen()
        lcd.putstr("Now included in")
        lcd.move_to(1,0) 
        lcd.putstr("my calculations")
        time.sleep(2)
        clear_screen()



def decide(temp, choices):
    """Decision logic with MOSFET control using all three choices"""
    decision = "Maybe"  # Default
    
    # Simple example: count how many times each choice was selected
    choice_counts = {1:0, 2:0, 3:0}
    for choice in choices:
        choice_counts[choice] += 1
    
    if temp < 22.0:
        decision = "Yes" if choice_counts[1] > 1 else "Maybe" if choice_counts[2] > 1 else "No"
    elif 22.0 <= temp <= 26.0:
        decision = "Maybe" if choice_counts[1] > 1 else "Yes" if choice_counts[2] > 1 else "Maybe"
    else:
        decision = "No" if choice_counts[1] > 1 else "Maybe" if choice_counts[2] > 1 else "Yes"
    
    # Control MOSFET based on decision
    greenLED.value(1 if decision == "Yes" else 0)
    redLED.value(1 if decision == "No" else 0)
    blueLED.value(1 if decision == "Maybe" else 0)
    return decision




def restart_program():
    """Reset after showing results"""
    time.sleep(5)  # Show decision for 5 seconds
    greenLED.off()  # Turn off MOSFET
    blueLED.off()
    redLED.off()
    machine.reset()  # Soft reboot



def main():
    clear_screen()
    user_menu()

    # Measure temperature
    clear_screen()
    lcd.putstr("Measure temp")
    time.sleep(5)
    
    temps = [sensor.object_temp for _ in range(3)]
    user_temp = sum(temps) / len(temps)
    
    clear_screen()
    lcd.putstr(f"Temp: {user_temp:.1f}C")
    time.sleep(3)

    comment_temp(user_temp)

    # Three rounds of selections
    choices = []
    for round_num in range(3):
        clear_screen()
        lcd.putstr(f"Round {round_num+1}: Pick")
        lcd.move_to(1, 0)
        lcd.putstr("what resonates")
        time.sleep(3)

        random_line = get_random_line("selections.txt")
        option1, option2, option3 = random_line.split(',')

        clear_screen()
        lcd.putstr(f"1:{option1} 2:{option2}")
        lcd.move_to(1, 0)
        lcd.putstr(f"3:{option3}")

        choices.append(wait_for_button())

    # Make decision based on temperature and all three choices
    decision = decide(user_temp, choices)
    
    # Show result
    clear_screen()
    lcd.putstr("Decision:")
    lcd.move_to(1, 0)
    lcd.putstr(decision)
    
    restart_program()



if __name__ == "__main__":
    main()


